#!/bin/bash
set -e

CACHE_FILE_INSTALLED=/tmp/eix-installed
CACHE_FILE_ALL=/tmp/eix-all

check_requirements() {
  local missing=0
  for cmd in eix equery fzf-tmux; do
    if ! command -v "$cmd" &> /dev/null; then
      echo "Error: Required command '$cmd' not found" >&2
      missing=1
    fi
  done
  if [ $missing -eq 1 ]; then
    exit 1
  fi
}

function updateGetAllCache {
  local silent=${1:-0}
  # shellcheck disable=SC2016
  if [ "$silent" -eq 1 ]; then
    equery list -o -p -F '$cp' "*" 2>/dev/null | uniq | sort > "$CACHE_FILE_ALL" || {
      echo "Error: Failed to update package cache" >&2
      return 1
    }
  else
    equery list -o -p -F '$cp' "*" 2>/dev/null | uniq | tee >(sort > "$CACHE_FILE_ALL") || {
      echo "Error: Failed to update package cache" >&2
      return 1
    }
  fi
}

function updateGetInstalledCache {
  local silent=${1:-0}
  # shellcheck disable=SC2016
  if [ "$silent" -eq 1 ]; then
    equery list -F '$cp' "*" 2>/dev/null | uniq | sort > "$CACHE_FILE_INSTALLED" || {
      echo "Error: Failed to update installed package cache" >&2
      return 1
    }
  else
    equery list -F '$cp' "*" 2>/dev/null | uniq | tee >(sort > "$CACHE_FILE_INSTALLED") || {
      echo "Error: Failed to update installed package cache" >&2
      return 1
    }
  fi
}

function getPackages {
  if [ ! -f "$CACHE_FILE" ]; then
    $updateGetCache 0
  else
    cat "$CACHE_FILE"
  fi
}

show_help() {
  printf "usage: %s [options]\n\n" "$0"
  printf "  -f, --refresh         Refresh cache\n"
  printf "  -F, --refresh-silent  Refresh cache and do not output anything (useful\n"
  printf "                        for updating the cache in a hook or cron job)\n"
  printf "  -i, --installed       Query only installed packages (Default)\n"
  printf "  -a, --all             Query all packages\n"
  printf "  -n, --no-preview      Don't show preview window (Default)\n"
  printf "  -p, --preview         Show preview window with package details\n"
  printf "  -E, --no-eix          Don't run eix on selection, just print package name\n"
  printf "  -h, --help            Show this help\n"
  printf "\n"
}

check_requirements

refresh=0
nooutput=0
CACHE_FILE="$CACHE_FILE_INSTALLED"
updateGetCache=updateGetInstalledCache
EIX="eix -I"
preview=0
runEIX=1

process_option() {
  case "$1" in
    f|refresh)
      refresh=1
      ;;
    F|refresh-silent)
      refresh=1
      nooutput=1
      ;;
    i|installed)
      CACHE_FILE="$CACHE_FILE_INSTALLED"
      updateGetCache=updateGetInstalledCache
      EIX="eix -I"
      ;;
    a|all)
      CACHE_FILE="$CACHE_FILE_ALL"
      updateGetCache=updateGetAllCache
      EIX="eix"
      ;;
    p|preview)
      preview=1
      ;;
    n|no-preview)
      preview=0
      ;;
    E|no-eix)
      runEIX=0
      ;;
    h|help)
      show_help
      exit 0
      ;;
    *)
      echo "Error: Unknown option: $1" >&2
      show_help
      exit 1
      ;;
  esac
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --*)
      # Long option
      process_option "${1#--}"
      shift
      ;;
    -*)
      # Short option(s) - could be bundled
      opt="${1#-}"
      shift
      if [[ ${#opt} -eq 1 ]]; then
        # Single short option
        process_option "$opt"
      else
        # Bundled short options
        for (( i=0; i<${#opt}; i++ )); do
          process_option "${opt:$i:1}"
        done
      fi
      ;;
    *)
      break
      ;;
  esac
done

preview_command=""
if [ "$preview" -eq 1 ]; then
  preview_command="$EIX -F {}"
fi

if [ "$nooutput" -eq 1 ]; then
  if [ "$refresh" -eq 1 ]; then
    $updateGetCache 1
  fi
  exit 0
fi

if [ "$refresh" -eq 1 ]; then
  rm -f "$CACHE_FILE"
fi

fzf_args=("+s")
if [ -n "$preview_command" ]; then
  fzf_args+=("--preview" "$preview_command")
fi

if [ $# -gt 0 ]; then
  fzf_args+=("-1" "-q" "$1")
fi

package=$(getPackages | fzf-tmux "${fzf_args[@]}")

if [ -n "${package}" ]; then
  if [ "$runEIX" -eq 1 ]; then
    $EIX -e "${package}"
  else
    echo "${package}"
  fi
fi
